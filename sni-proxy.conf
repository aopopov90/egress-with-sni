# setup custom path that do not require root access
pid /tmp/nginx.pid;

events {
}

stream {
  log_format log_stream '\$remote_addr [\$time_local] \$protocol [\$ssl_preread_server_name]'
  '\$status \$bytes_sent \$bytes_received \$session_time';

  access_log /var/log/nginx/access.log log_stream;
  error_log  /var/log/nginx/error.log;

  # tcp forward proxy by SNI
  server {
    resolver 8.8.8.8 ipv6=off;
    listen       127.0.0.1:18443;
    proxy_pass   $ssl_preread_server_name:443;
    ssl_preread  on;
    # ssl_certificate /etc/istio/egress-app-credential/tls.crt;
    # ssl_certificate_key /etc/istio/egress-app-credential/tls.key;
    proxy_ssl on;
    # proxy_ssl_verify on;
    # proxy_ssl_trusted_certificate /etc/istio/egress-app-credential/ca.crt;
    proxy_ssl_certificate /etc/istio/egress-app-credential/tls.crt;
    proxy_ssl_certificate_key /etc/istio/egress-app-credential/tls.key;
    # proxy_ssl_server_name on;
  }
}